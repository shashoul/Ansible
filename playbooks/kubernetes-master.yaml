---
- hosts: host2
  become: true

  tasks:
  - name: apt update
    apt: update_cache=yes
 
  - name: install apt-transport-https
    apt: name=apt-transport-https state=latest
  
  - name: install docker 
    apt: name=docker.io state=latest
 
  - name: start docker
    service: name=docker state=restarted

#  - name: Remove swapfile from /etc/fstab
#    mount:
#      name: swap
#      fstype: swap
#      state: absent

#  - name: Disable swap
#    command: swapoff -a

  - name: download and add the key for the kubernetes install
    apt_key: url=https://packages.cloud.google.com/apt/doc/apt-key.gpg state=present

  - name: add kubernetes repository
    apt_repository: 
      repo: deb http://apt.kubernetes.io/ kubernetes-xenial main 
      state: present
      filename: 'kubernetes.list'

  - name: apt update
    apt: update_cache=yes

  - name: install kubelet kubeadm kubectl 
    apt: name={{ item }} state=latest
    with_items:
      - kubelet
      - kubeadm
      - kubectl
  
  - name: kubeadm reset 
    command: kubeadm reset
  
  - name: Kubeadm init
    command: kubeadm init

#  - name: export KUBECONFIG
#    command: sudo export KUBECONFIG=/etc/kubernetes/admin.conf

  - name: mkdir -p $HOME/.kube
    command: mkdir -p $HOME/.kube

  - name:  cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
    command: cp -i /etc/kubernetes/admin.conf $HOME/.kube/config

  - name: chown $(id -u):$(id -g) $HOME/.kube/config
    command: chown $(id -u):$(id -g) $HOME/.kube/config 

  - name: install WEAVE (CNI)
    command: kubectl apply -f https://git.io/weave-kube-1.6
